# 트렌드 비디오 자동화 기능 목록

## 상품 자동화 기능

### 테스트 기능에서의 상품 자동화
**구현 위치**: `src/app/api/automation/test-generate-stream/route.ts`

**동작 흐름**:

#### Step 1: 베스트셀러에서 상품 조회
1. **쿠팡 베스트셀러 API 호출**
   - `/v2/providers/affiliate_open_api/apis/openapi/v1/products/bestcategories/1001`
   - HMAC-SHA256 서명으로 인증
   - 베스트셀러 순위 상품 자동 선택

#### Step 2: 딥링크 생성
1. **딥링크 API 호출**
   - 베스트셀러 상품 URL을 딥링크로 변환
   - `/v2/providers/affiliate_open_api/apis/openapi/v1/deeplink` 호출
   - `https://link.coupang.com/a/xxxxx` 형태로 변환
   - 실패 시 에러 발생 (원본 URL 사용 안 함)

#### Step 3: 내 목록(내목록)에 추가
1. **상품 저장 로직** (향후 추가 예정)
   - `coupang_products` 테이블에 상품 INSERT
   - 저장 항목:
     - `product_id` (쿠팡 상품 ID)
     - `product_name` (상품명)
     - `deep_link` (생성된 딥링크)
     - `image_url` (상품 이미지)
     - `original_price`, `discount_price` (가격)
     - `status` ('active')
   - 스케줄러가 자동으로 감지

#### Step 4: 스케줄러 자동화 - 예약큐 자동 등록
1. **스케줄러가 신규 상품 감지** (3초 간격)
   - `coupang_products` 테이블에서 미처리 상품 조회
   - 상품별 카테고리 확인

2. **자동 스케줄 생성**
   - `video_titles` 테이블에 타이틀 생성
   - 상품 정보 저장
   - `video_schedules` 테이블에 스케줄 자동 등록
   - 카테고리별 채널 자동 배정
   - YouTube 프라이버시: 'public' 설정

3. **예약큐 자동 실행**
   - 스케줄된 시간에 자동으로 처리
   - 대본 생성 → 영상 생성 → YouTube 업로드
   - 전체 프로세스 자동화

**관련 파일**:
- `src/app/api/automation/test-generate-stream/route.ts` - 테스트 기능 및 베스트셀러 조회
- `src/lib/coupang-deeplink.ts` - 딥링크 생성 유틸리티
- `src/lib/automation-scheduler.ts` - 스케줄러 (신규 상품 감지 및 자동 등록)
- `src/app/api/coupang/products/route.ts` - 베스트셀러 조회 API

**특징**:
- ✅ 베스트셀러에서 상품 자동 조회
- ✅ 딥링크 자동 생성
- 🔄 내 목록에 자동 추가 (향후)
- 🔄 스케줄러가 자동으로 감지 (향후)
- 🔄 예약큐에 자동 등록 (향후)
- ✅ 예약된 시간에 영상 생성 및 업로드

**상태**: ⚠️ 부분 구현 (Step 1, 2 완료 / Step 3, 4 개발 중)

---

## 자동화 상품카테고리 (Product Category Automation)

**기능 설명**: 쿠팡 베스트셀러에서 새로운 상품을 가져와 내목록에 등록하고, 카테고리별로 예약큐를 자동 등록

**동작 흐름**:

### Step 1: 베스트셀러에서 신규 상품 조회
1. 쿠팡 베스트셀러 API 호출
   - `/v2/providers/affiliate_open_api/apis/openapi/v1/products/bestcategories/[CATEGORY_ID]`
   - 각 카테고리별 베스트셀러 상품 목록 조회

2. **내목록 중복 체크**
   - `coupang_products` 테이블에서 이미 등록된 상품 조회
   - 베스트셀러 상품과 비교하여 **미등록 신규 상품만 필터링**

3. **신규 상품 선택**
   - 미등록 상품 중 순위가 높은 상품부터 선택 (상위 5개~10개)

### Step 2: 딥링크 생성 및 내목록 등록
1. **딥링크 생성**
   - 베스트셀러 API의 긴 affiliate URL → 짧은 딥링크 변환
   - `generateDeeplink()` 함수로 변환
   - `https://link.coupang.com/a/xxxxx` 형태

2. **내목록에 상품 등록**
   - `coupang_products` 테이블에 INSERT
   - 저장 항목:
     - `product_id` (쿠팡 상품 ID)
     - `product_name` (상품명)
     - `deep_link` (생성된 딥링크)
     - `category_id` (카테고리 ID)
     - `image_url` (상품 이미지)
     - `original_price`, `discount_price` (가격)
     - `status` ('active')

### Step 3: 카테고리별 자동 예약큐 등록
1. **상품 정보 준비**
   - 등록된 상품의 상세 정보 조회
   - 카테고리에 맞는 AI 프롬프트 선택

2. **타이틀 자동 생성**
   - 상품 정보 기반 AI 타이틀 생성
   - `video_titles` 테이블에 저장
   - 상품 카테고리별로 맞춤형 타이틀 생성

3. **카테고리별 스케줄 자동 등록**
   - 카테고리에 따라 채널 자동 배정 (예: "의류" → 패션 채널)
   - `video_schedules` 테이블에 INSERT
   - 자동으로 스케줄 시간 설정 (카테고리별 최적 업로드 시간)
   - YouTube 프라이버시: 'public'으로 설정

4. **상태 업데이트**
   - `video_titles` 상태: 'pending' → 'scheduled'
   - `video_schedules` 상태: 'pending'

**구현 위치**:
- `src/app/api/automation/test-generate-stream/route.ts` - 메인 로직 (Step 1, 2)
- `src/app/api/automation/[category]/auto-schedule/route.ts` - 카테고리별 자동 스케줄 (Step 3) **[필요]**
- `src/lib/coupang-deeplink.ts` - 딥링크 생성
- `src/lib/automation.ts` - DB 쿼리 함수

**관련 테이블**:
```sql
-- coupang_products: 내목록 상품
CREATE TABLE coupang_products (
  id TEXT PRIMARY KEY,
  product_id TEXT,
  product_name TEXT,
  deep_link TEXT,
  category_id TEXT,          -- 카테고리 ID
  image_url TEXT,
  original_price INTEGER,
  discount_price INTEGER,
  status TEXT DEFAULT 'active'
);

-- video_titles: 생성된 타이틀
CREATE TABLE video_titles (
  id TEXT PRIMARY KEY,
  title TEXT,
  type TEXT,
  category TEXT,             -- 카테고리 ('의류', '가전', '식품' 등)
  product_url TEXT,          -- 쿠팡 딥링크
  status TEXT DEFAULT 'pending'
);

-- video_schedules: 예약큐
CREATE TABLE video_schedules (
  id TEXT PRIMARY KEY,
  title_id TEXT,
  product_url TEXT,          -- 쿠팡 딥링크
  channel TEXT,              -- 카테고리별 자동 배정 채널
  youtube_privacy TEXT DEFAULT 'public',
  status TEXT DEFAULT 'pending'
);
```

**특징**:
- ✅ 완전 자동화: 사용자 개입 없음
- ✅ 신규 상품만 등록: 내목록 중복 체크
- ✅ 카테고리 맞춤: 카테고리별 채널/타이틀 최적화
- ✅ 즉시 스케줄: 등록 후 자동으로 예약큐 생성

**상태**: ⚠️ 부분 구현 (Step 1, 2는 완료, Step 3 미구현)

---

## 상품 타이틀 자동 생성

**구현 위치**: `src/app/api/automation/titles/route.ts`

**동작 흐름**:
1. **상품 정보 조회**
   - 쿠팡 상품 URL에서 상품 ID 추출
   - API를 통해 상품 이름, 가격, 카테고리 등 조회

2. **AI 타이틀 생성**
   - 상품 정보를 기반으로 프롬프트 생성
   - Claude/ChatGPT API 호출
   - 유튜브 최적화 타이틀 생성

3. **타이틀 저장**
   - `video_titles` 테이블에 저장
   - 상품 정보(JSON) 함께 저장

**관련 파일**:
- `src/app/api/automation/titles/route.ts` - 타이틀 API
- `src/lib/automation.ts` - DB 쿼리 함수

**상태**: ⚠️ 부분 구현 (수동 입력은 가능, 자동 생성은 미구현)

---

## 자동화 스케줄 관리

**구현 위치**: `src/app/api/automation/schedules/route.ts`

**동작 흐름**:
1. **스케줄 생성**
   - 타이틀 선택
   - 채널 선택
   - 업로드 날짜/시간 설정
   - YouTube 프라이버시 설정

2. **스케줄 조회**
   - 채널별 스케줄 조회
   - 상태별 스케줄 필터링 (pending, processing, completed, failed, cancelled)
   - 달력 뷰로 조회

3. **스케줄 실행**
   - `video_schedules` 테이블에서 pending 상태 조회
   - 자동화 스케줄러가 이를 처리

**관련 파일**:
- `src/app/api/automation/schedules/route.ts` - 스케줄 관리 API
- `src/app/api/automation/calendar/route.ts` - 캘린더 조회 API
- `src/lib/automation.ts` - DB 쿼리 함수
- `src/lib/automation-scheduler.ts` - 스케줄 실행 로직

**상태**: ✅ 완료

---

## 자동화 스케줄러 (자동 실행)

**구현 위치**: `src/lib/automation-scheduler.ts`

**동작 흐름**:
1. **스케줄 감시** (3초 간격)
   - pending 상태의 스케줄 조회
   - 실행할 작업 확인

2. **대본 생성**
   - `/api/generate-script` 호출
   - 상품 정보 + 타이틀 기반 대본 생성

3. **영상 생성**
   - `/api/generate-video` 호출
   - 대본 + 이미지/영상 기반 영상 생성

4. **상태 업데이트**
   - `automation_pipelines` 테이블에 진행 상황 기록
   - 각 단계별 로그 저장

5. **YouTube 업로드**
   - `/api/youtube/upload` 호출
   - 메타데이터(제목, 설명, 태그) 설정
   - 완료 상태로 업데이트

**관련 파일**:
- `src/lib/automation-scheduler.ts` - 스케줄러 메인 로직 (1200+ 라인)
- `src/lib/automation.ts` - DB 쿼리 및 헬퍼 함수
- `src/app/api/generate-script/route.ts` - 대본 생성 API
- `src/app/api/generate-video/route.ts` - 영상 생성 API
- `src/app/api/youtube/upload/route.ts` - YouTube 업로드 API

**주요 함수**:
- `startAutomationScheduler()` - 스케줄러 시작
- `processPendingSchedules()` - pending 스케줄 처리
- `checkAndCreateAutoSchedules()` - 자동 스케줄 생성
- `updateScheduleStatus()` - 상태 업데이트

**상태**: ✅ 완료

---

## 기타 기능

(추가 기능은 여기에 작성)
