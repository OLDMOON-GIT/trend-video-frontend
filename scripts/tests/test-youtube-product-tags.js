const fs = require('fs');
const path = require('path');

let testResults = { passed: 0, failed: 0, tests: [] };

function addTestResult(name, passed, message) {
  testResults.tests.push({ name, passed, message });
  if (passed) {
    testResults.passed++;
    console.log(`âœ… ${name}: ${message}`);
  } else {
    testResults.failed++;
    console.error(`âŒ ${name}: ${message}`);
  }
}

async function runTests() {
  console.log('ğŸ§ª ìƒí’ˆ ì˜ìƒ YouTube ì—…ë¡œë“œ ìë™ íƒœê·¸/ì„¤ëª… í…ŒìŠ¤íŠ¸\n');

  // í…ŒìŠ¤íŠ¸ 1: automation-scheduler.ts - descriptionì— title ë„£ì§€ ì•ŠëŠ”ì§€ í™•ì¸
  const schedulerPath = path.join(__dirname, 'trend-video-frontend', 'src', 'lib', 'automation-scheduler.ts');
  const schedulerContent = fs.readFileSync(schedulerPath, 'utf-8');

  const hasEmptyDescription = schedulerContent.includes("description: ''") ||
                               schedulerContent.includes('description: ""') ||
                               schedulerContent.includes("description: '', // ë¹ˆ ë¬¸ìì—´");
  const noTitleInDescription = !schedulerContent.match(/description:\s*job\.title|description:\s*schedule\.title/);

  addTestResult('automation-scheduler description', hasEmptyDescription && noTitleInDescription,
    hasEmptyDescription ? 'descriptionì´ ë¹ˆ ë¬¸ìì—´ë¡œ ì„¤ì •ë¨' : 'descriptionì— titleì´ ë“¤ì–´ê°€ ìˆìŒ');

  // í…ŒìŠ¤íŠ¸ 2: youtube/upload/route.ts - product íƒ€ì… ê°ì§€ ì½”ë“œ í™•ì¸
  const uploadPath = path.join(__dirname, 'trend-video-frontend', 'src', 'app', 'api', 'youtube', 'upload', 'route.ts');
  const uploadContent = fs.readFileSync(uploadPath, 'utf-8');

  const hasProductDetection = uploadContent.includes("job.type === 'product'");
  addTestResult('product íƒ€ì… ê°ì§€', hasProductDetection, hasProductDetection ? 'product íƒ€ì… ê°ì§€ ì½”ë“œ ì¡´ì¬' : 'ì½”ë“œ ëˆ„ë½');

  // í…ŒìŠ¤íŠ¸ 3: autoGeneratedTags ë³€ìˆ˜ ì¡´ì¬ í™•ì¸
  const hasAutoTags = uploadContent.includes('autoGeneratedTags');
  addTestResult('autoGeneratedTags ë³€ìˆ˜', hasAutoTags, hasAutoTags ? 'ë³€ìˆ˜ ì¡´ì¬' : 'ë³€ìˆ˜ ëˆ„ë½');

  // í…ŒìŠ¤íŠ¸ 4: autoGeneratedDescription ë³€ìˆ˜ ì¡´ì¬ í™•ì¸
  const hasAutoDesc = uploadContent.includes('autoGeneratedDescription');
  addTestResult('autoGeneratedDescription ë³€ìˆ˜', hasAutoDesc, hasAutoDesc ? 'ë³€ìˆ˜ ì¡´ì¬' : 'ë³€ìˆ˜ ëˆ„ë½');

  // í…ŒìŠ¤íŠ¸ 5: íƒœê·¸ ìë™ ìƒì„± ë¡œì§ í™•ì¸
  const hasTagGeneration = uploadContent.includes('title.split') &&
                            uploadContent.includes('ìƒí’ˆë¦¬ë·°') &&
                            uploadContent.includes('ì¶”ì²œ') &&
                            uploadContent.includes('ì‡¼í•‘');
  addTestResult('íƒœê·¸ ìë™ ìƒì„± ë¡œì§', hasTagGeneration,
    hasTagGeneration ? 'í‚¤ì›Œë“œ ì¶”ì¶œ ë° ê¸°ë³¸ íƒœê·¸ ì¶”ê°€ ë¡œì§ ì¡´ì¬' : 'ë¡œì§ ëˆ„ë½');

  // í…ŒìŠ¤íŠ¸ 6: description ìë™ ìƒì„± ë¡œì§ í™•ì¸
  const hasDescGeneration = uploadContent.includes('ìƒí’ˆ ì •ë³´ëŠ” ì˜ìƒ ì„¤ëª…ë€') ||
                             uploadContent.includes('êµ¬ë…ê³¼ ì¢‹ì•„ìš”');
  addTestResult('ì„¤ëª… ìë™ ìƒì„± ë¡œì§', hasDescGeneration,
    hasDescGeneration ? 'ê¸°ë³¸ ìƒí’ˆ ì„¤ëª… ìƒì„± ë¡œì§ ì¡´ì¬' : 'ë¡œì§ ëˆ„ë½');

  // í…ŒìŠ¤íŠ¸ 7: metadataì— autoGeneratedTags ì‚¬ìš© í™•ì¸
  const usesAutoTags = uploadContent.includes('tags: autoGeneratedTags');
  addTestResult('metadata tags', usesAutoTags, usesAutoTags ? 'autoGeneratedTags ì‚¬ìš©' : 'ì¼ë°˜ tags ì‚¬ìš©');

  // í…ŒìŠ¤íŠ¸ 8: finalDescriptionì´ autoGeneratedDescriptionì„ ì‚¬ìš©í•˜ëŠ”ì§€ í™•ì¸
  const usesFinalDesc = uploadContent.includes('const finalDescription = autoGeneratedDescription') ||
                         uploadContent.includes('finalDescription = autoGeneratedDescription');
  const metadataUsesFinaldesc = uploadContent.match(/description:\s*finalDescription/);
  addTestResult('metadata description', usesFinalDesc && metadataUsesFinaldesc,
    usesFinalDesc && metadataUsesFinaldesc ? 'autoGeneratedDescription â†’ finalDescription â†’ metadata ì—°ê²°ë¨' : 'ì—°ê²° ì•ˆë¨');

  // ê²°ê³¼ ìš”ì•½
  console.log('\n' + '='.repeat(60));
  console.log(`âœ… í†µê³¼: ${testResults.passed}/${testResults.tests.length}`);
  console.log(`âŒ ì‹¤íŒ¨: ${testResults.failed}/${testResults.tests.length}`);
  console.log('='.repeat(60));

  if (testResults.failed > 0) {
    console.log('\nğŸ” ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸:');
    testResults.tests.filter(t => !t.passed).forEach(t => {
      console.log(`  - ${t.name}: ${t.message}`);
    });
  } else {
    console.log('\nâœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼!');
    console.log('\nğŸ“‹ êµ¬í˜„ëœ ê¸°ëŠ¥:');
    console.log('  1. automation-scheduler: descriptionì— title ì œê±°');
    console.log('  2. youtube/upload: product íƒ€ì… ê°ì§€');
    console.log('  3. ìë™ íƒœê·¸ ìƒì„± (ì œëª© í‚¤ì›Œë“œ + ìƒí’ˆë¦¬ë·°, ì¶”ì²œ, ì‡¼í•‘)');
    console.log('  4. ìë™ ì„¤ëª… ìƒì„± (ìƒí’ˆ ì •ë³´ ì•ˆë‚´ + êµ¬ë… ìš”ì²­)');
    console.log('\nğŸ’¡ ë™ì‘ ë°©ì‹:');
    console.log('  - ìƒí’ˆ ì˜ìƒ(job.type === "product")ì„ YouTubeì— ì—…ë¡œë“œí•˜ë©´');
    console.log('  - íƒœê·¸ê°€ ë¹„ì–´ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ìƒì„±');
    console.log('  - ì„¤ëª…ì´ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ ì„¤ëª… ìƒì„±');
    console.log('  - ì¼ë°˜ ì˜ìƒì€ ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ë™ì‘');
  }

  process.exit(testResults.failed === 0 ? 0 : 1);
}

runTests().catch(error => {
  console.error('âŒ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì˜¤ë¥˜:', error);
  process.exit(1);
});
