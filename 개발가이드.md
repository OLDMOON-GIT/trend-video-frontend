# 트렌드 비디오 자동화 개발 가이드

## 상품 자동화 기능 (Product Automation)

### 개요
트렌드 비디오 자동화 시스템의 핵심 기능인 상품 자동화는 쿠팡 베스트셀러에서 상품을 자동으로 가져와 영상으로 변환하는 완전 자동화 시스템입니다.

### 4단계 자동화 프로세스

#### Step 1: 쿠팡 베스트셀러에서 상품 조회
**목적**: 실시간으로 인기 있는 쿠팡 상품을 자동으로 발견

**구현 위치**: `src/app/api/automation/test-generate-stream/route.ts` (Line 223-273)

**동작 방식**:
1. Coupang Affiliate API에 접근
2. 베스트셀러 카테고리 1001번에서 상위 상품 조회
3. HMAC-SHA256 서명으로 API 요청 인증
4. 상품명, 가격, 이미지 URL 추출

**코드 예시**:
```typescript
const API_PATH = '/v2/providers/affiliate_open_api/apis/openapi/v1/products/bestcategories/1001';
const response = await fetch(`https://api-gateway.coupang.com${API_PATH}`, {
  method: 'GET',
  headers: {
    'Authorization': authorization,
    'Content-Type': 'application/json'
  }
});
```

**주의사항**:
- 쿠팡 API 키는 `data/coupang-settings.json`에서 로드
- 베스트셀러는 자동으로 상위 상품 1순위 선택
- API 인증 실패 시 전체 프로세스 중단

---

#### Step 2: 딥링크(Deep Link) 자동 생성
**목적**: 긴 쿠팡 URL을 짧은 딥링크로 변환하여 YouTube 설명에 적합하게 만들기

**구현 위치**: `src/app/api/automation/test-generate-stream/route.ts` (Line 289-330)

**동작 방식**:
1. 베스트셀러 API에서 받은 상품 URL 정규화
2. 표준 형식: `https://www.coupang.com/vp/products/{productId}`로 변환
3. Coupang Deeplink API 호출
4. 짧은 딥링크 생성: `https://link.coupang.com/a/xxxxx`

**API 엔드포인트**:
```
POST /v2/providers/affiliate_open_api/apis/openapi/v1/deeplink
Content-Type: application/json

{
  "coupangUrls": ["https://www.coupang.com/vp/products/123456"]
}

응답:
{
  "rCode": "0",
  "data": [
    {
      "shortenUrl": "https://link.coupang.com/a/xxxxx"
    }
  ]
}
```

**DB 저장 방식**:
- `video_titles.product_url` = 생성된 딥링크 (short URL)
- `video_titles.product_data` JSON에 양쪽 URL 모두 저장:
  ```json
  {
    "deepLink": "https://link.coupang.com/a/c59d9h",
    "productUrl": "https://www.coupang.com/vp/products/...",
    "productName": "상품명",
    "productPrice": 7500
  }
  ```

**UI 표시 우선순위**:
1. `product_data.deepLink` (짧은 링크) - 최우선
2. `product_data.productUrl` (원본 쿠팡 링크) - 2순위
3. `product_url` 컬럼값 - 3순위

**주의사항**:
- 딥링크 생성 실패 시 에러 발생 (원본 URL 폴백 없음)
- 모든 곳에서 딥링크를 우선 표시해야 함
- UI에서 `startEdit()` 호출 시 product_data에서 deepLink 추출

---

#### Step 3: 내 목록(coupang_products)에 자동 저장
**목적**: 생성된 상품을 "내 목록"에 저장하여 scheduler가 감지할 수 있도록 준비

**구현 위치**: `src/app/api/automation/test-generate-stream/route.ts` (Line 377-402)

**동작 방식**:
1. Step 2에서 딥링크 생성 완료 후 실행
2. `coupang_products` 테이블에 INSERT
3. 상품 정보 저장 (ID, 이름, 딥링크, 가격, 이미지)
4. status='active'로 설정하여 scheduler 감지 준비

**저장되는 데이터**:
```typescript
db.prepare(`
  INSERT INTO coupang_products (
    id, user_id, product_id, product_name, deep_link, category_id,
    image_url, original_price, discount_price, status, created_at
  ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, datetime('now'))
`).run(
  coupangProductId,           // 자동 생성 ID
  user.userId,                 // 사용자 ID
  productIdToUse,              // Coupang 상품 ID
  product.title,               // 상품명
  product.deep_link,           // 생성된 딥링크
  category,                    // 카테고리
  product.image_url,           // 상품 이미지
  product.original_price,      // 정가
  product.discount_price,      // 할인가
  'active'                     // 상태
);
```

**테이블 스키마**:
```sql
CREATE TABLE coupang_products (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL,
  product_id TEXT NOT NULL,
  product_name TEXT NOT NULL,
  deep_link TEXT NOT NULL,
  category_id TEXT,
  image_url TEXT,
  original_price INTEGER,
  discount_price INTEGER,
  status TEXT DEFAULT 'active' CHECK(status IN ('active', 'inactive', 'removed')),
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(user_id, product_id)
);
```

**에러 처리**:
- 저장 실패해도 video_titles 등록은 계속 진행
- 실패 로그는 ui 에 표시하되 프로세스 중단 없음

---

#### Step 4: Scheduler 자동 감지 및 예약큐 등록
**목적**: coupang_products에 저장된 상품을 감지하여 자동으로 예약큐(video_schedules)에 등록

**구현 위치**: `src/lib/automation-scheduler.ts` (Line 1720-1824)

**함수명**: `checkAndRegisterCoupangProducts()`

**동작 방식**:
1. **감지**: coupang_products 테이블에서 status='active'이고 아직 스케줄이 없는 상품 조회
2. **제목 생성**: 각 상품마다 video_titles 테이블에 새로운 항목 생성
3. **채널 배정**: 사용자의 활성화된 첫 번째 채널 자동 배정
4. **스케줄 계산**: calculateNextScheduleTime() 함수로 다음 업로드 시간 계산
5. **큐 등록**: video_schedules 테이블에 status='pending'으로 등록
6. **자동 실행**: Scheduler 주기 체크(3초 간격)에서 자동 감지

**호출 위치**:
```typescript
// src/lib/automation-scheduler.ts

// 1. Scheduler 시작 시 즉시 실행 (Line 95)
checkAndRegisterCoupangProducts();

// 2. 주기적 체크 루프에서 계속 실행 (Line 114)
schedulerInterval = setInterval(() => {
  processPendingSchedules();
  checkWaitingForUploadSchedules();
  checkReadyToUploadSchedules();
  checkCompletedShortformJobs();
  checkAndRegisterCoupangProducts();  // ← Step 4 실행
  // ... 나머지 체크
}, checkInterval);
```

**구현 코드**:
```typescript
export async function checkAndRegisterCoupangProducts() {
  try {
    const db = new Database(dbPath);

    // 1. 감지: 스케줄이 없는 활성 상품 조회
    const newProducts = db.prepare(`
      SELECT cp.*
      FROM coupang_products cp
      WHERE cp.status = 'active'
        AND NOT EXISTS (
          SELECT 1 FROM video_schedules vs
          WHERE vs.product_url LIKE '%' || SUBSTR(cp.deep_link, -6) || '%'
        )
      ORDER BY cp.created_at DESC
      LIMIT 10
    `).all() as any[];

    if (newProducts.length === 0) {
      console.log('[Step 4] No new products detected for scheduling');
      return { success: 0, failed: 0, skipped: 0 };
    }

    console.log(`[Step 4] Detected ${newProducts.length} new products`);

    let successCount = 0;
    let failedCount = 0;

    for (const product of newProducts) {
      try {
        // 2. video_titles 항목 생성
        const titleId = `title_${Date.now()}_${Math.random().toString(36).substring(2, 15)}`;
        const productData = JSON.stringify({
          productId: product.product_id,
          productName: product.product_name,
          productPrice: product.discount_price || product.original_price,
          productImage: product.image_url,
          deepLink: product.deep_link
        });

        // 3. 채널 자동 배정
        const channelSetting = db.prepare(`
          SELECT channel_id, channel_name FROM youtube_channel_settings
          WHERE user_id = ? AND is_active = 1
          LIMIT 1
        `).get(product.user_id) as any;

        if (!channelSetting) {
          console.log(`[Step 4] No active channel for user, skipping`);
          continue;
        }

        // video_titles에 저장
        db.prepare(`
          INSERT INTO video_titles (
            id, user_id, title, category, type, status,
            channel, product_url, product_data, created_at
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, datetime('now'))
        `).run(
          titleId, product.user_id, product.product_name,
          product.category_id || '상품', 'product', 'pending',
          channelSetting.channel_id, product.deep_link, productData
        );

        // 4. 스케줄 계산 및 5. 큐 등록
        const scheduleId = `schedule_${Date.now()}_${Math.random().toString(36).substring(2, 15)}`;
        const { calculateNextScheduleTime } = await import('./automation');
        const scheduledTime = calculateNextScheduleTime(product.user_id, channelSetting.channel_id) || new Date();

        db.prepare(`
          INSERT INTO video_schedules (
            id, title_id, scheduled_time, status, channel_setting_id, created_at
          ) VALUES (?, ?, ?, ?, ?, datetime('now'))
        `).run(
          scheduleId, titleId, scheduledTime.toISOString(),
          'pending', channelSetting.channel_id
        );

        console.log(`[Step 4] ✅ Product registered: ${product.product_name}`);
        successCount++;

      } catch (error: any) {
        console.error(`[Step 4] ❌ Failed: ${error.message}`);
        failedCount++;
      }
    }

    db.close();
    return { success: successCount, failed: failedCount, skipped: 0 };

  } catch (error: any) {
    console.error('[Step 4] Error:', error.message);
    return { success: 0, failed: 0, skipped: 0 };
  }
}
```

**주의사항**:
- coupang_products의 status가 'active'인 상품만 처리
- 이미 video_schedules에 등록된 상품은 제외
- 채널이 없으면 스킵 (사용자가 채널을 활성화해야 함)
- 최대 10개까지만 한 번에 처리 (DB 부하 방지)
- 에러 발생 시 나머지 상품은 계속 처리

---

### 전체 흐름도

```
테스트 버튼 클릭
    ↓
Step 1: 베스트셀러 API 호출 → 상품 정보 조회
    ↓
Step 2: 딥링크 API 호출 → 짧은 URL 생성
    ↓
Step 3: coupang_products 테이블에 저장 → status='active'
    ↓
video_titles 저장 (product_url = deeplink)
    ↓
Scheduler 감지 (3초 주기)
    ↓
Step 4: checkAndRegisterCoupangProducts() 실행
    ↓
video_schedules에 자동 등록 → status='pending'
    ↓
Scheduler가 pending 스케줄 감지
    ↓
대본 생성 → 영상 생성 → YouTube 업로드
```

---

### 핵심 파일 및 코드 위치

| 파일 | 역할 | Line |
|------|------|------|
| `src/app/api/automation/test-generate-stream/route.ts` | Step 1-3 구현 | 223-402 |
| `src/lib/automation.ts` | coupang_products 테이블 생성 | 380-403 |
| `src/lib/automation-scheduler.ts` | Step 4 scheduler 구현 | 1720-1824 |
| `src/app/automation/page.tsx` | UI에서 deeplink 표시 | 2740, 2790, 3432 |
| `기능목록.md` | 기능 명세서 | - |

---

### 테스트 방법

#### 수동 테스트
1. 자동화 페이지 → "테스트" 버튼 클릭
2. 실시간 로그 확인:
   - ✅ "쿠팡 베스트셀러에서 상품 발견"
   - ✅ "딥링크 생성 완료"
   - ✅ "내 목록 등록 완료"
   - ✅ "상품 등록 완료"
3. 자동화 페이지 새로고침
4. 제목 목록에서 새 상품 확인
5. "수정" 버튼 클릭 → "URL (딥링크)" 확인

#### 상품 확인
- `coupang_products` 테이블에서 status='active' 레코드 확인
- `video_titles` 테이블에서 type='product' 레코드 확인
- `video_schedules` 테이블에서 status='pending' 레코드 확인

---

### 자주 발생하는 오류 및 해결책

#### 1. "딥링크 생성 실패: url convert failed"
**원인**: API 경로 또는 URL 형식이 잘못됨

**해결책**:
- API 경로: `/v2/providers/affiliate_open_api/apis/openapi/v1/deeplink` (v1 필수)
- URL 형식: `https://www.coupang.com/vp/products/{productId}`로 정규화
- 빈 문자열이 아닌지 확인

```typescript
const standardProductUrl = `https://www.coupang.com/vp/products/${productIdToUse}`;
```

#### 2. "쿠팡 API 오류: 401"
**원인**: 인증 실패 (API 키 또는 서명 오류)

**해결책**:
- `data/coupang-settings.json` 파일 확인
- accessKey, secretKey 정확성 확인
- 시간 동기화 확인 (HMAC 서명에 현재 시간 사용)

#### 3. "No active channel found"
**원인**: 사용자의 활성화된 YouTube 채널이 없음

**해결책**:
- 설정 → YouTube 채널 → "활성화" 확인
- youtube_channel_settings 테이블에서 is_active=1 확인

#### 4. 딥링크가 UI에 안 보임
**원인**: product_data JSON 파싱 실패 또는 deepLink 필드 없음

**해결책**:
- `startEdit()` 함수에서 product_data JSON 파싱 확인
- DB에 저장된 product_data 확인
- 폴백: productUrl → product_url 순서 확인

---

### 성능 최적화

#### 대량 상품 처리
- `checkAndRegisterCoupangProducts()`에서 한 번에 최대 10개 처리
- 필요시 LIMIT 값 조정 가능

#### 데이터베이스 인덱스
```sql
-- coupang_products 조회 성능
CREATE INDEX idx_coupang_products_user_status ON coupang_products(user_id, status);
```

#### API 호출 최적화
- 베스트셀러는 상위 1개만 선택 (API 호출 1회)
- 딥링크는 배치 처리 가능 (최대 10개/요청)

---

### 체크리스트

상품 자동화 기능을 구현할 때 확인해야 할 사항:

- [ ] Step 1: Coupang 베스트셀러 API 호출 성공
- [ ] Step 2: 딥링크 API 호출 성공 및 URL 생성 확인
- [ ] Step 3: coupang_products 테이블에 상품 저장 확인
- [ ] Step 4: video_titles에 type='product' 레코드 생성 확인
- [ ] Step 5: video_schedules에 status='pending' 레코드 생성 확인
- [ ] UI: deeplink가 모든 곳에 표시되는지 확인
- [ ] Scheduler: 3초 주기로 checkAndRegisterCoupangProducts() 실행 확인
- [ ] 에러 처리: 실패해도 다음 상품 계속 처리하는지 확인
- [ ] 로깅: 각 단계별 로그가 정확히 남는지 확인

---

**마지막 업데이트**: 2025년 11월 20일
**상태**: ✅ 완전 구현 (Step 1 ~ 4 모두 완료)
